<!DOCTYPE html>
<html lang="ku">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Ø§ØªÛŒ Ú©ÙˆØ±Ø¯ØªÙˆÙˆÚµØ³ÛØ±Ú¤Û•Ø±</title>
    <style>
        :root { --primary-color: #4f46e5; --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --glass-bg: rgba(255, 255, 255, 0.9); --my-msg: #4f46e5; --other-msg: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: rtl; background: var(--bg-gradient); background-attachment: fixed; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: #1f2937; }
        .container { background: var(--glass-bg); backdrop-filter: blur(10px); width: 95%; max-width: 450px; height: 90vh; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #auth-container { padding: 40px 20px; text-align: center; justify-content: center; }
        h2 { color: var(--primary-color); margin-bottom: 30px; font-size: 24px; }
        input { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #e5e7eb; border-radius: 12px; box-sizing: border-box; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-login { background: var(--primary-color); color: white; }
        .btn-login:hover { background: #4338ca; transform: translateY(-2px); }
        .btn-signup { background: #e0e7ff; color: var(--primary-color); }
        header { padding: 20px; background: white; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; }
        #messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: #f9fafb; }
        .chat-message { max-width: 80%; padding: 12px 16px; border-radius: 18px; position: relative; font-size: 15px; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); animation: slideMsg 0.3s ease-out; }
        @keyframes slideMsg { from { opacity: 0; scale: 0.9; } to { opacity: 1; scale: 1; } }
        .chat-message.me { align-self: flex-start; background: var(--my-msg); color: white; border-bottom-right-radius: 4px; }
        .chat-message.other { align-self: flex-end; background: var(--other-msg); color: #374151; border-bottom-left-radius: 4px; border: 1px solid #e5e7eb; }
        .username { font-size: 11px; margin-bottom: 4px; display: block; opacity: 0.8; font-weight: bold; }
        .timestamp { display: block; font-size: 10px; opacity: 0.6; margin-top: 5px; direction: ltr; text-align: right; }
        .input-area { padding: 20px; background: white; display: flex; gap: 10px; align-items: center; }
        #message-input { margin: 0; background: #f3f4f6; border: none; }
        .icon-btn { background: #f3f4f6; color: #4b5563; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .send-btn { background: var(--primary-color); color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        #logout-btn { background: #fee2e2; color: #ef4444; padding: 8px 12px; font-size: 12px; }
        #typing-indicator { font-size: 11px; color: #4f46e5; font-style: italic; margin-top: 2px; display: block; height: 14px; }
    </style>
</head>
<body>

    <div id="auth-container" class="container">
        <h2>ğŸ‘‹ Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª</h2>
        <p style="color: #6b7280; margin-bottom: 20px;">Ø¨Û† Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†ÛŒ Ú†Ø§Øª Ù„Û†Ú¯ÛŒÙ† Ø¨Ú©Û•</p>
        <input type="email" id="email" placeholder="Ø¦ÛŒÙ…Û•ÛŒÚµÛ•Ú©Û•Øª Ø¨Ù†ÙˆÙˆØ³Û•...">
        <input type="password" id="password" placeholder="ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ...">
        <div class="btn-group">
            <button class="btn-login" onclick="login()">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
            <button class="btn-signup" onclick="signup()">Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†</button>
        </div>
        <p id="auth-message" style="margin-top:15px; font-size:14px; color:#ef4444;"></p>
    </div>

    <div id="chat-container" class="container hidden">
        <header>
            <div>
                <b id="username-display" style="color: var(--primary-color);">Ù†Ø§ÙˆÛ•Ú©Û•Øª</b>
                <div id="status-box">
                    <span id="online-label" style="font-size: 10px; color: #10b981;">â— Ø¦Û†Ù†Ù„Ø§ÛŒÙ†</span>
                    <span id="typing-indicator"></span>
                </div>
            </div>
            <button id="logout-btn" onclick="logout()">Ú†ÙˆÙˆÙ†Û•Ø¯Û•Ø±Û•ÙˆÛ•</button>
        </header>

        <div id="messages"></div>

        <div class="input-area">
            <input type="file" id="image-upload" accept="image/*" style="display: none;">
            <button class="icon-btn" onclick="document.getElementById('image-upload').click()">ğŸ–¼ï¸</button>
            <input type="text" id="message-input" placeholder="Ù¾Û•ÛŒØ§Ù… Ø¨Ù†ÙˆÙˆØ³Û•..." autofocus>
            <button class="send-btn" onclick="sendMessage()">ğŸš€</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDirc0CpBTWr5gxtZQv4ASZv8VRPP2QT90",
            authDomain: "kurdtoolserver.firebaseapp.com",
            databaseURL: "https://kurdtoolserver-default-rtdb.firebaseio.com",
            projectId: "kurdtoolserver",
            storageBucket: "kurdtoolserver.appspot.com",
            messagingSenderId: "215346001086",
            appId: "1:215346001086:android:8bb74d10253a878b9ddaef"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        let currentUsername = null;
        let typingTimeout;
        const authMessageEl = document.getElementById('auth-message');

        async function signup() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (password.length < 6) { authMessageEl.textContent = 'ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ù¾ÛÙˆÛŒØ³ØªÛ• Ù„Û• 6 Ù¾ÛŒØª Ú©Û•Ù…ØªØ± Ù†Û•Ø¨ÛØª.'; return; }
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.sendEmailVerification();
                authMessageEl.style.color = '#10b981';
                authMessageEl.textContent = 'âœ”ï¸ Ø¦Û•Ú©Ø§ÙˆÙ†Øª Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø§! ØªÚ©Ø§ÛŒÛ• Ø¦ÛŒÙ…Û•ÛŒÚµÛ•Ú©Û•Øª Ú¤ÛØ±ÛŒÙØ§ÛŒ Ø¨Ú©Û•.';
            } catch (error) { authMessageEl.textContent = 'Ù‡Û•ÚµÛ•: ' + error.message; }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                if (!userCredential.user.emailVerified) {
                    auth.signOut();
                    authMessageEl.textContent = 'âŒ ØªÚ©Ø§ÛŒÛ• Ø¦ÛŒÙ…Û•ÛŒÚµÛ•Ú©Û•Øª Ú¤ÛØ±ÛŒÙØ§ÛŒ Ø¨Ú©Û•.';
                }
            } catch (error) { authMessageEl.textContent = 'Ù‡Û•ÚµÛ•: ' + error.message; }
        }

        function logout() { 
            if(currentUsername) db.ref('typing/' + currentUsername).remove();
            auth.signOut(); 
        }

        auth.onAuthStateChanged(user => {
            if (user && user.emailVerified) {
                currentUsername = user.email.split('@')[0];
                document.getElementById('username-display').textContent = currentUsername;
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('chat-container').classList.remove('hidden');
                loadMessages();
                listenForTyping();
            } else {
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('chat-container').classList.add('hidden');
            }
        });

        // --- âŒ¨ï¸ Typing Logic ---
        document.getElementById('message-input').addEventListener('input', () => {
            if (!currentUsername) return;
            db.ref('typing/' + currentUsername).set(true);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                db.ref('typing/' + currentUsername).remove();
            }, 2000);
        });

        function listenForTyping() {
            const indicator = document.getElementById('typing-indicator');
            const onlineLabel = document.getElementById('online-label');
            db.ref('typing').on('value', snap => {
                const data = snap.val() || {};
                const typers = Object.keys(data).filter(u => u !== currentUsername);
                if (typers.length > 0) {
                    indicator.textContent = `âœï¸ ${typers.join(', ')} Ø®Û•Ø±ÛŒÚ©ÛŒ Ù†ÙˆÙˆØ³ÛŒÙ†Û•...`;
                    onlineLabel.classList.add('hidden');
                } else {
                    indicator.textContent = "";
                    onlineLabel.classList.remove('hidden');
                }
            });
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const file = document.getElementById('image-upload').files[0];
            const text = input.value.trim();
            const timestamp = Date.now();
            if (!text && !file) return;
            
            db.ref('typing/' + currentUsername).remove(); // Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ù†ÛŒØ´Ø§Ù†Ø¯Û•Ø±ÛŒ Ù†ÙˆÙˆØ³ÛŒÙ† Ø¯ÙˆØ§ÛŒ Ù†Ø§Ø±Ø¯Ù†

            if (file) {
                const ref = storage.ref(`chat/${timestamp}_${currentUsername}`);
                await ref.put(file);
                const url = await ref.getDownloadURL();
                db.ref('messages').push({ username: currentUsername, imageUrl: url, timestamp: timestamp });
            }
            if (text) {
                db.ref('messages').push({ username: currentUsername, text: text, timestamp: timestamp });
            }
            input.value = '';
            document.getElementById('image-upload').value = '';
        }

        function formatTimestamp(ts) {
            const date = new Date(ts);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        function loadMessages() {
            const msgDiv = document.getElementById('messages');
            msgDiv.innerHTML = ""; 
            db.ref('messages').limitToLast(50).on('child_added', snap => {
                const data = snap.val();
                const el = document.createElement('div');
                el.className = `chat-message ${data.username === currentUsername ? 'me' : 'other'}`;
                let html = `<span class="username">${data.username}</span>`;
                if (data.text) html += `<div>${data.text}</div>`;
                if (data.imageUrl) html += `<div class="message-image"><img src="${data.imageUrl}" style="max-width:100%; border-radius:10px;"></div>`;
                html += `<span class="timestamp">${formatTimestamp(data.timestamp || Date.now())}</span>`;
                el.innerHTML = html;
                msgDiv.appendChild(el);
                msgDiv.scrollTop = msgDiv.scrollHeight;
            });
        }

        document.getElementById('message-input').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
    </script>
</body>
</html>
